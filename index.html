<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MEbank Choice – Examen Único</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<meta name="theme-color" content="#ffffff">
<style>
:root{--bg:#ffffff;--text:#0f172a;--muted:#475569;--soft:#f1f5f9;--line:#e2e8f0;--brand:#2563eb;--accent:#22c55e;--danger:#ef4444;--card:#ffffff}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
a{color:inherit;text-decoration:none}
.header{position:sticky;top:0;z-index:20;background:var(--card);box-shadow:0 6px 24px rgba(2,6,23,.08)}
.wrap{max-width:900px;margin:0 auto;padding:14px 16px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:12px}
.brand h1{margin:0;font-size:clamp(18px,3vw,22px);font-weight:700}
.small{font-size:12px;color:var(--muted)}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button{background:#fff;color:var(--text);border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;cursor:pointer;transition:.15s transform ease}
button:hover{transform:translateY(-1px)}
.btn{background:var(--soft)}.btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.icon-btn{width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(2,6,23,.08)}
.footer{color:var(--muted);text-align:center;font-size:12px;padding:14px}
.logo-heart{width:26px;height:26px}
.hidden{display:none}
/* Acordeón minimalista */
.accordion{list-style:none;margin:0;padding:0;max-width:700px}
.acc-item{border-bottom:1px solid var(--line);padding:10px 4px}
.acc-header{display:flex;gap:10px;align-items:center;cursor:pointer}
.acc-title{font-weight:600}
.acc-content{padding:10px 0 8px 24px;display:none}
.acc-actions{display:flex;gap:8px}
/* Preguntas */
.question-stem{font-size:18px;line-height:1.45;white-space:pre-wrap}
.options{margin-top:12px;display:grid;gap:10px}
.option{border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;gap:10px;align-items:flex-start;background:var(--card);cursor:pointer}
.option.correct{border-color:rgba(34,197,94,.9);box-shadow:inset 0 0 0 1px rgba(34,197,94,.35)}
.option.wrong{border-color:rgba(239,68,68,.9);box-shadow:inset 0 0 0 1px rgba(239,68,68,.35)}
.explain{margin-top:12px;color:var(--muted);font-size:14px;white-space:pre-wrap}
.nav-row{display:flex;gap:8px;margin-top:12px}
.badge{display:inline-block;padding:3px 8px;border:1px solid var(--line);border-radius:999px;font-size:11px;color:#7c3aed;background:#faf5ff}
</style>
</head>
<body>
  <div class="header">
    <div class="wrap row" style="justify-content:space-between">
      <div class="brand">
        <svg class="logo-heart" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Logo">
          <path d="M12 22 C12 12, 28 10, 32 20 C36 10, 52 12, 52 22 C52 36, 38 42, 32 50 C26 42, 12 36, 12 22 Z" stroke="#B91C1C" stroke-width="2" fill="none" />
        </svg>
        <div>
          <h1>MEbank Choice – Examen Único</h1>
          <div class="small">Lista simple por materia · Práctica y Estadísticas</div>
        </div>
      </div>
      <div class="controls">
        <span id="adminBadge" class="badge hidden">Modo admin</span>
        <button id="gear" class="icon-btn hidden" title="Modo edición (PIN)">⚙️</button>
        <button id="btnImport" class="btn hidden">Importar</button>
        <label id="owWrap" class="btn hidden" style="display:none"><input type="checkbox" id="overwrite"> Sobrescribir duplicados</label>
        <input id="fileInput" type="file" accept="application/json" class="hidden"/>
      </div>
    </div>
  </div>

  <main class="wrap" id="app"></main>

  <div class="footer">Hecho con ❤️ · MEbank</div>

<script>
/*** ---------- Admin por URL ---------- ***/
const adminActive = new URLSearchParams(location.search).get('admin') === '1';
if(adminActive){ document.getElementById('gear').classList.remove('hidden'); document.getElementById('adminBadge').classList.remove('hidden'); }

/*** ---------- Datos de ejemplo ---------- ***/
const starter = {
  subjects: [
    { slug:"obstetricia", name:"Obstetricia", desc:"MSAL / SOGIBA – estilo Examen Único." },
    { slug:"pediatria", name:"Pediatría", desc:"Guías SAP." },
    { slug:"infectologia", name:"Infectología", desc:"MSAL." }
  ],
  questions: [
    {id:"OB-PN-001",materia:"obstetricia",subtema:"Controles prenatales",enunciado:"Gestante de 12 semanas, ¿qué estudio NO corresponde al primer control?",opciones:["Grupo y factor Rh","Glucemia en ayunas","VDRL/RPR","Urocultivo de control a las 28 semanas"],correcta:3,explicacion:"El urocultivo de control a las 28 semanas no corresponde al primer control; se solicita urocultivo inicial y repetir según riesgo."},
    {id:"OB-HTA-001",materia:"obstetricia",subtema:"HTA en el embarazo",enunciado:"30 semanas, TA 152/96 mmHg, asintomática, proteinuria negativa. Conducta inicial:",opciones:["Reposo absoluto","Metildopa VO","Inducir parto","Sulfato de magnesio profiláctico"],correcta:1,explicacion:"HTA gestacional sin severidad: manejo ambulatorio y antihipertensivo oral; MgSO4 no corresponde sin criterios de severidad."},
    {id:"PE-BRN-001",materia:"pediatria",subtema:"Bronquiolitis",enunciado:"Lactante con dificultad respiratoria, tiraje subcostal y sibilancias. Tratamiento inicial:",opciones:["Antibiótico empírico","Salbutamol en MDI con aerocámara","Corticoides sistémicos","Oxígeno según SatO2"],correcta:3,explicacion:"Soporte: oxígeno si SatO2 baja; broncodilatadores no de rutina."}
  ]
};

/*** ---------- Estado ---------- ***/
const LS_BANK = "mebank_bank_v2";
const LS_PROGRESS = "mebank_prog_v2";
const LS_ADMIN = "mebank_admin_hash_v2";
let BANK = JSON.parse(localStorage.getItem(LS_BANK) || "null") || starter;
const PROG = JSON.parse(localStorage.getItem(LS_PROGRESS) || "{}"); // {materia:{qid:'ok'|'bad'}}
function saveAll(){ localStorage.setItem(LS_BANK, JSON.stringify(BANK)); localStorage.setItem(LS_PROGRESS, JSON.stringify(PROG)); }

/*** ---------- Acordeón ---------- ***/
const app = document.getElementById('app');
function subjectsFromBank(){
  const known = new Map((BANK.subjects||[]).map(s=>[s.slug,s]));
  (BANK.questions||[]).forEach(q=>{ if(q && q.materia && !known.has(q.materia)){ known.set(q.materia,{slug:q.materia,name:q.materia[0].toUpperCase()+q.materia.slice(1),desc:""});} });
  return Array.from(known.values()).sort((a,b)=>a.name.localeCompare(b.name));
}

let openSlug = null;
function renderHome(){
  const subs = subjectsFromBank();
  const list = subs.map(s=>{
    const open = s.slug===openSlug;
    return `<li class="acc-item">
      <div class="acc-header" onclick="toggleAcc('${s.slug}')">
        <div class="acc-title">${s.name}</div>
      </div>
      <div class="acc-content" id="acc-${s.slug}" style="display:${open?'block':'none'}">
        <div class="acc-actions">
          <button class="btn" onclick="startPractica('${s.slug}')">Práctica</button>
          <button class="btn" onclick="showStats('${s.slug}')">Estadísticas</button>
        </div>
      </div>
    </li>`;
  }).join('');
  app.innerHTML = `<ul class="accordion">${list}</ul>`;
}
window.toggleAcc = (slug)=>{ openSlug = (openSlug===slug? null : slug); renderHome(); };
renderHome();

/*** ---------- Motor de práctica ---------- ***/
let CURRENT = { list:[], i:0, materia:'' };
function startPractica(slug){
  const list = (BANK.questions||[]).filter(q=>q.materia===slug).sort((a,b)=> a.id.localeCompare(b.id));
  if(!list.length){ app.innerHTML = `<div class="card">No hay preguntas cargadas en <b>${slug}</b>. Entrá en modo admin (?admin=1) y usá <b>Importar</b>.</div>`; return; }
  CURRENT = { list, i:0, materia:slug };
  renderQuestion();
}
function renderQuestion(){
  const q = CURRENT.list[CURRENT.i];
  const prog = PROG[CURRENT.materia]||{};
  const answered = prog[q.id];
  const opts = q.opciones.map((txt, idx)=>{
    let cls='';
    if(answered){ if(idx===q.correcta) cls='correct'; else if(idx===answered?.chosen) cls='wrong'; }
    return `<label class="option ${cls}" onclick="answer(${idx})"><input type="radio" name="opt"> <div>${String.fromCharCode(97+idx)}) ${txt}</div></label>`;
  }).join('');
  const explain = answered? `<div class="explain">${q.explicacion||''}</div>` : '';
  const nav = `<div class="nav-row">
    <button class="btn" onclick="prevQ()">Anterior</button>
    <button class="btn" onclick="nextQ()">Siguiente</button>
    <button class="btn" onclick="backHome()">Volver</button>
  </div>`;
  app.innerHTML = `<div class="card">
    <div class="row" style="justify-content:space-between"><div><b>${CURRENT.materia.toUpperCase()}</b> · <span class="small">Pregunta ${CURRENT.i+1} de ${CURRENT.list.length}</span></div></div>
    <div class="question-stem" style="margin-top:8px">${q.enunciado}</div>
    <div class="options">${opts}</div>
    ${explain}
    ${nav}
  </div>`;
}
window.backHome = ()=> renderHome();
window.prevQ = ()=>{ if(CURRENT.i>0){ CURRENT.i--; renderQuestion(); } };
window.nextQ = ()=>{ if(CURRENT.i<CURRENT.list.length-1){ CURRENT.i++; renderQuestion(); } };

window.answer = (idx)=>{
  const q = CURRENT.list[CURRENT.i];
  PROG[CURRENT.materia] = PROG[CURRENT.materia]||{};
  if(PROG[CURRENT.materia][q.id]?.chosen!=null) return; // ya respondida
  PROG[CURRENT.materia][q.id] = { chosen: idx, status: (idx===q.correcta?'ok':'bad') };
  saveAll();
  renderQuestion();
};

/*** ---------- Estadísticas por materia ---------- ***/
window.showStats = (slug)=>{
  const total = (BANK.questions||[]).filter(q=>q.materia===slug).length;
  const prog = PROG[slug]||{};
  const vals = Object.values(prog);
  const ok = vals.filter(v=>v.status==='ok').length;
  const bad = vals.filter(v=>v.status==='bad').length;
  app.innerHTML = `<div class="card">
    <h3>Estadísticas · ${slug.toUpperCase()}</h3>
    <p>Total de preguntas: <b>${total}</b></p>
    <p>Correctas: <b style="color:#16a34a">${ok}</b> · Incorrectas: <b style="color:#ef4444">${bad}</b></p>
    <div class="nav-row"><button class="btn" onclick="backHome()">Volver</button></div>
  </div>`;
};

/*** ---------- Admin: PIN local + Import ---------- ***/
const gear = document.getElementById('gear');
const btnImport = document.getElementById('btnImport');
const owWrap = document.getElementById('owWrap');
const overwrite = document.getElementById('overwrite');
const fileInput = document.getElementById('fileInput');

async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

if(adminActive){
  gear.onclick = async ()=>{
    const saved = localStorage.getItem(LS_ADMIN);
    if(!saved){
      const p1 = prompt("Configurá tu PIN de edición (4–10 dígitos/letras):"); if(!p1) return;
      const p2 = prompt("Repetí tu PIN:"); if(p1!==p2){ alert("No coinciden."); return; }
      localStorage.setItem(LS_ADMIN, await sha256Hex(p1));
      alert("PIN guardado ✅");
    }else{
      const pin = prompt("Ingresá tu PIN:"); if(!pin) return;
      const ok = (await sha256Hex(pin))===saved; if(!ok){ alert("PIN incorrecto"); return; }
    }
    [btnImport, owWrap].forEach(el=>{el.classList.remove('hidden'); el.style.display='';});
    alert("Modo edición activado ✅");
  };
  btnImport.onclick = ()=> fileInput.click();
  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    try{
      const text = await f.text();
      const data = JSON.parse(text);
      const arr = Array.isArray(data)? data : (data.questions||[]);
      if(!Array.isArray(arr) || !arr.length) throw new Error("JSON inválido: se esperaba un array de preguntas o {questions:[...]}");
      const errors=[];
      arr.forEach((q,i)=>{
        if(!q.id) errors.push(`Item ${i}: falta 'id'`);
        if(!q.materia) errors.push(`Item ${i}: falta 'materia'`);
        if(!Array.isArray(q.opciones)||q.opciones.length!==4) errors.push(`Item ${i}: 'opciones' debe tener 4 strings`);
        if(typeof q.correcta!=='number' || q.correcta<0 || q.correcta>3) errors.push(`Item ${i}: 'correcta' debe ser 0..3`);
      });
      if(errors.length){ alert("Errores:\\n"+errors.slice(0,12).join("\\n")); return; }

      // Merge materias
      const subMap = new Map(subjectsFromBank().map(s=>[s.slug,s]));
      arr.forEach(q=>{ if(!subMap.has(q.materia)) subMap.set(q.materia,{slug:q.materia,name:q.materia[0].toUpperCase()+q.materia.slice(1),desc:""}); });
      BANK.subjects = Array.from(subMap.values());

      // Merge preguntas
      const byId = new Map((BANK.questions||[]).map(q=>[q.id,q]));
      arr.forEach(q=>{
        if(byId.has(q.id)){ if(overwrite.checked){ byId.set(q.id,q); } }
        else byId.set(q.id,q);
      });
      BANK.questions = Array.from(byId.values());
      saveAll();
      alert(`Importadas ${arr.length} preguntas ✅`);
      renderHome();
    }catch(err){ alert("No se pudo importar: "+err.message); }
    finally{ e.target.value=""; }
  });
}
</script>
</body>
</html>
